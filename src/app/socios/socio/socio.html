<div class="container-fluid">
  
  <div *ngIf="successMessage" class="alert alert-success alert-dismissible fade show" role="alert">
    <i class="bi bi-check-circle-fill me-2"></i> {{ successMessage }}
    <button type="button" class="btn-close" (click)="successMessage = null"></button>
  </div>

  <!-- === BARRA DE BÚSQUEDA === -->
  <div class="row mb-3">
    <div class="col-md-6">
      <div class="input-group">
        <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
        <input type="text" class="form-control" placeholder="Buscar por Nombre, Apellido o DNI..." 
               [(ngModel)]="terminoBusqueda" (keyup.enter)="buscar()">
        
        <button class="btn btn-primary" (click)="buscar()">Buscar</button>
        
        <button class="btn btn-outline-secondary" *ngIf="enBusqueda" (click)="limpiarBusqueda()" title="Limpiar filtro">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h2 class="h4 mb-0">
        Gestión de Socios 
        <!-- Badge que indica si estamos filtrando -->
        <span *ngIf="enBusqueda" class="badge bg-warning text-dark ms-2">Resultados de Búsqueda</span>
        <span *ngIf="!enBusqueda && filtroActual !== 'TODOS'" class="badge bg-secondary ms-2">{{ filtroActual }}S</span>
      </h2>
      <button class="btn btn-primary" (click)="openModal()">
        <i class="bi bi-plus-lg me-2"></i> Agregar Socio
      </button>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
          <thead class="table-dark">
            <tr>
              <th>IdPadrón</th><th>Nombre</th><th>DNI</th><th>Puesto</th><th>Estado</th><th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let socio of socios">
              <td>{{ socio.id }}</td>
              <td>{{ socio.nombre }} {{ socio.apellido }}</td>
              <td>{{ socio.dni }}</td>
              
              <td>
                <span *ngIf="socio.numeroPuesto" class="badge bg-info text-dark">
                  <i class="bi bi-shop me-1"></i> {{ socio.numeroPuesto }}
                </span>
                <span *ngIf="!socio.numeroPuesto" class="text-muted small">Sin puesto</span>
              </td>

              <td>
                <span class="badge" 
                  [class.bg-success]="socio.estadoUsuario === 'ACTIVO'" 
                  [class.bg-secondary]="socio.estadoUsuario !== 'ACTIVO'">
                  {{ socio.estadoUsuario }}
                </span>
              </td>

              <td>
                <button class="btn btn-sm btn-warning me-2" (click)="openModal(socio)" title="Editar">
                  <i class="bi bi-pencil-fill"></i>
                </button>
                <button class="btn btn-sm" 
                        [class.btn-danger]="socio.estadoUsuario === 'ACTIVO'"
                        [class.btn-success]="socio.estadoUsuario !== 'ACTIVO'"
                        (click)="openEstadoModal(socio)"
                        [title]="socio.estadoUsuario === 'ACTIVO' ? 'Desactivar' : 'Activar'">
                  <i class="bi" [class.bi-person-x-fill]="socio.estadoUsuario === 'ACTIVO'" 
                     [class.bi-person-check-fill]="socio.estadoUsuario !== 'ACTIVO'"></i>
                </button>
              </td>
            </tr>
            <tr *ngIf="socios.length === 0">
              <td colspan="6" class="text-center text-muted py-4">
                {{ enBusqueda ? 'No se encontraron resultados.' : 'No hay socios en esta lista.' }}
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- MODAL AGREGAR/EDITAR (Con Validaciones Completas) -->
<div class="modal fade" #socioModal id="socioModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{{ modalTitle }}</h5>
        <button type="button" class="btn-close" (click)="closeSocioModal()"></button>
      </div>
      <div class="modal-body">
        
        <div *ngIf="errorMessage" class="alert alert-danger">{{ errorMessage }}</div>
        
        <form #socioForm="ngForm" (ngSubmit)="saveSocio()">
          
          <h5 class="text-primary">Datos de Usuario</h5>
          <hr class="mt-0">
          
          <div class="row">
            <div class="col-md-4 mb-3">
              <label class="form-label">Tipo Documento (*)</label>
              <select class="form-select" [(ngModel)]="currentSocio.tipoDocumento" name="tipoDocumento" required
                      (change)="onTipoDocumentoChange()">
                <option *ngFor="let tipo of tiposDocumento" [value]="tipo">{{ tipo }}</option>
              </select>
            </div>

            <div class="col-md-4 mb-3">
              <label class="form-label">N° Documento (*)</label>
              <input type="text" class="form-control" [(ngModel)]="currentSocio.dni" name="dni" 
                     required [minlength]="docMinLength" [maxlength]="docMaxLength" [pattern]="docPattern" 
                     #docCtrl="ngModel" [class.is-invalid]="docCtrl.invalid && (docCtrl.dirty || docCtrl.touched)">
              <div class="invalid-feedback" *ngIf="docCtrl.errors?.['required']">Requerido.</div>
              <div class="invalid-feedback" *ngIf="docCtrl.errors?.['minlength']">Debe tener {{ docMinLength }} dígitos.</div>
              <div class="invalid-feedback" *ngIf="docCtrl.errors?.['pattern']">Formato inválido.</div>
            </div>

            <div class="col-md-4 mb-3">
              <label class="form-label">Username (*)</label>
              <div class="input-group has-validation">
                <span class="input-group-text">@</span>
                <input type="text" class="form-control" [(ngModel)]="currentSocio.username" name="username" 
                       required minlength="4" #userCtrl="ngModel" (blur)="verificarUsername()"
                       [class.is-invalid]="(userCtrl.invalid && (userCtrl.dirty || userCtrl.touched)) || usernameExiste">
                <div class="invalid-feedback" *ngIf="usernameExiste">Usuario ya existe.</div>
                <div class="invalid-feedback" *ngIf="userCtrl.errors?.['minlength']">Mínimo 4 caracteres.</div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Nombre (*)</label>
              <input type="text" class="form-control" [(ngModel)]="currentSocio.nombre" name="nombre" 
                     required minlength="3" pattern="^[a-zA-ZáéíóúÁÉÍÓÚñÑ ]*$" #nombreCtrl="ngModel"
                     [class.is-invalid]="nombreCtrl.invalid && (nombreCtrl.dirty || nombreCtrl.touched)">
              <div class="invalid-feedback" *ngIf="nombreCtrl.errors?.['required']">Obligatorio.</div>
              <div class="invalid-feedback" *ngIf="nombreCtrl.errors?.['minlength']">Mínimo 3 letras.</div>
              <div class="invalid-feedback" *ngIf="nombreCtrl.errors?.['pattern']">Solo letras.</div>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Apellido (*)</label>
              <input type="text" class="form-control" [(ngModel)]="currentSocio.apellido" name="apellido" 
                     required minlength="3" pattern="^[a-zA-ZáéíóúÁÉÍÓÚñÑ ]*$" #apellidoCtrl="ngModel"
                     [class.is-invalid]="apellidoCtrl.invalid && (apellidoCtrl.dirty || apellidoCtrl.touched)">
              <div class="invalid-feedback">Mínimo 3 letras.</div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Teléfono (*)</label>
              <input type="text" class="form-control" [(ngModel)]="currentSocio.numero" name="numero" 
                     required minlength="9" maxlength="9" pattern="^[0-9]*$" #fonoCtrl="ngModel"
                     [class.is-invalid]="fonoCtrl.invalid && (fonoCtrl.dirty || fonoCtrl.touched)">
              <div class="invalid-feedback">Solo números (9 dígitos).</div>
            </div>
            <div class="col-md-6 mb-3">
               <label class="form-label">Contraseña <span *ngIf="!currentSocioId">(*)</span></label>
               <input type="password" class="form-control" [(ngModel)]="currentSocio.password" name="password" 
                      [required]="!currentSocioId" minlength="6" #passCtrl="ngModel"
                      [class.is-invalid]="passCtrl.invalid && (passCtrl.dirty || passCtrl.touched)">
               <div class="invalid-feedback">Mínimo 6 caracteres.</div>
               <div *ngIf="currentSocioId" class="form-text">Dejar vacío para mantener la actual.</div>
            </div>
          </div>

          <h5 class="text-primary mt-3">Datos de Socio</h5>
          <hr class="mt-0">

          <div class="mb-3">
            <label class="form-label">Dirección (*)</label>
            <input type="text" class="form-control" [(ngModel)]="currentSocio.direccion" name="direccion" 
                   required minlength="5" #dirCtrl="ngModel"
                   [class.is-invalid]="dirCtrl.invalid && (dirCtrl.dirty || dirCtrl.touched)">
            <div class="invalid-feedback">Mínimo 5 caracteres.</div>
          </div>
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">N° Tarjeta (*)</label>
              <input type="text" class="form-control" [(ngModel)]="currentSocio.tarjetaSocio" name="tarjetaSocio" 
                     required minlength="3" #tarjetaCtrl="ngModel"
                     [class.is-invalid]="tarjetaCtrl.invalid && (tarjetaCtrl.dirty || tarjetaCtrl.touched)">
              <div class="invalid-feedback">Obligatorio.</div>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Carnet</label>
              <select class="form-select" [(ngModel)]="currentSocio.carnetSanidad" name="carnetSanidad" required>
                <option value="VIGENTE">VIGENTE</option>
                <option value="VENCIDO">VENCIDO</option>
              </select>
            </div>
          </div>

          <!-- ASIGNAR PUESTO (Con Filtro de Pasaje) -->
          <div class="row" *ngIf="!currentSocioId">
            <div class="col-md-12 mb-3">
              <label class="form-label text-success fw-bold">Asignar Puesto (Opcional)</label>
              
              <div class="row g-2">
                <div class="col-md-4">
                  <select class="form-select" [(ngModel)]="pasajeSeleccionado" name="filtroPasaje" (change)="onPasajeChange()">
                    <option value="" disabled selected>Filtrar por Pasaje...</option>
                    <option *ngFor="let p of listaPasajes" [value]="p">{{ p }}</option>
                  </select>
                </div>
                <div class="col-md-8">
                  <select class="form-select border-success" [(ngModel)]="currentSocio.idPuesto" name="idPuesto" 
                          [disabled]="!pasajeSeleccionado">
                    <option [ngValue]="undefined">-- Sin Asignar --</option>
                    <option *ngFor="let p of puestosFiltrados" [value]="p.id">
                      {{ p.numeroPuesto }} ({{ p.ubicacion }})
                    </option>
                  </select> 
                </div>
              </div>
              <div class="form-text text-muted" *ngIf="!pasajeSeleccionado">Seleccione un pasaje para ver puestos disponibles.</div>
              <div class="form-text text-danger" *ngIf="pasajeSeleccionado && puestosFiltrados.length === 0">No hay puestos libres en este pasaje.</div>
            </div>
          </div>
        
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="closeSocioModal()">Cancelar</button>
            <button type="submit" class="btn btn-primary" 
                    [disabled]="socioForm.invalid || usernameExiste || (currentSocioId && !hasChanges())">
              <i class="bi bi-save me-1"></i> Guardar Cambios
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" #deleteConfirmModal id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirmar Cambio de Estado</h5>
        <button type="button" class="btn-close" (click)="closeDeleteModal()"></button>
      </div>
      <div class="modal-body">
        <p *ngIf="socioAEliminar">
          ¿Estás seguro de que deseas 
          <strong *ngIf="socioAEliminar.estadoUsuario === 'ACTIVO'" class="text-danger">DESACTIVAR</strong>
          <strong *ngIf="socioAEliminar.estadoUsuario !== 'ACTIVO'" class="text-success">ACTIVAR</strong>
          al socio <strong>{{ socioAEliminar.nombre }}</strong>?
        </p>
        <p *ngIf="socioAEliminar?.estadoUsuario === 'ACTIVO'" class="alert alert-warning py-2 small">
          <i class="bi bi-exclamation-triangle-fill me-1"></i> 
          El puesto quedará libre automáticamente.
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeDeleteModal()">Cancelar</button>
        <button type="button" class="btn btn-primary" (click)="confirmChangeState()">Confirmar</button>
      </div>
    </div>
  </div>
</div>