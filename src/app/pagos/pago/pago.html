<div class="container-fluid">
  
  <div *ngIf="successMessage" class="alert alert-success alert-dismissible fade show" role="alert">
    <i class="bi bi-check-circle-fill me-2"></i> {{ successMessage }}
    <button type="button" class="btn-close" (click)="successMessage = null"></button>
  </div>

  <!-- BARRA DE BÚSQUEDA -->
  <div class="row mb-3">
    <div class="col-md-6">
      <div class="input-group">
        <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
        <input type="text" class="form-control" placeholder="Buscar por N° Recibo, Socio o DNI..." 
               [(ngModel)]="terminoBusqueda" (keyup.enter)="buscarPagos()">
        <button class="btn btn-primary" (click)="buscarPagos()">Buscar</button>
        <button class="btn btn-outline-secondary" *ngIf="enBusqueda" (click)="limpiarBusqueda()">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h2 class="h4 mb-0">Gestión de Pagos</h2>
      <button class="btn btn-primary" (click)="openModal()">
        <i class="bi bi-plus-lg me-2"></i> Agregar Pago
      </button>
    </div>

    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
          <thead class="table-dark">
            <tr>
              <th>ID</th>
              <th>Socio</th>
              <th>DNI Socio</th>
              <th>Tipo</th>
              <th>Monto</th>
              <th>Fecha de Pago</th>
              <th>Observación</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let pago of pagos">
              <td>{{ pago.id }}</td>
              <td>{{ pago.socioNombreCompleto }}</td>
              <td>{{ pago.socioDni }}</td>
              <td>
                <span class="badge" 
                      [class.bg-primary]="pago.tipoPago === 'CUOTA_MENSUAL'"
                      [class.bg-danger]="pago.tipoPago === 'MULTA'"
                      [class.bg-warning]="pago.tipoPago === 'CUOTA_EXTRAORDINARIA'"
                      [class.bg-secondary]="pago.tipoPago === 'OTROS'">
                  {{ pago.tipoPago }}
                </span>
              </td>
              <td class="fw-bold">S/ {{ pago.monto | number:'1.2-2' }}</td>
              <td>{{ pago.fechaPago | date:'dd/MM/yyyy h:mm a' }}</td>
              <td>{{ pago.observacion }}</td>
              <td>
                <button class="btn btn-sm btn-warning me-2" (click)="openModal(pago)">
                  <i class="bi bi-pencil-fill"></i>
                </button>
                <button class="btn btn-sm btn-danger" (click)="openDeleteModal(pago)">
                  <i class="bi bi-trash-fill"></i>
                </button>
              </td>
            </tr>
            <tr *ngIf="pagos.length === 0">
              <td colspan="8" class="text-center text-muted py-4">
                {{ enBusqueda ? 'No se encontraron pagos.' : 'No hay pagos registrados.' }}
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- MODAL AGREGAR/EDITAR -->
<div class="modal fade" #pagoModal id="pagoModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{{ modalTitle }}</h5>
        <button type="button" class="btn-close" (click)="closePagoModal()"></button>
      </div>
      <div class="modal-body">
        <div *ngIf="errorMessage" class="alert alert-danger">{{ errorMessage }}</div>
        
        <form #pagoForm="ngForm" (ngSubmit)="savePago()">
          
          <!-- BUSCADOR DE SOCIO EN MODAL -->
          <div class="mb-4 p-3 border rounded bg-light">
            <label class="form-label fw-bold">Buscar Socio (*)</label>
            <div class="input-group mb-2">
              <input type="text" class="form-control" placeholder="DNI o Nombre..." 
                     [(ngModel)]="terminoBusquedaSocio" name="searchSocio"
                     [disabled]="socioSeleccionado !== null"
                     (keyup.enter)="buscarSocioParaPago()">
              
              <button class="btn btn-outline-primary" type="button" (click)="buscarSocioParaPago()" 
                      *ngIf="!socioSeleccionado" [disabled]="buscandoSocio">
                <i class="bi bi-search"></i>
              </button>
              
              <button class="btn btn-outline-danger" type="button" (click)="cancelarSeleccionSocio()" 
                      *ngIf="socioSeleccionado">
                Cambiar
              </button>
            </div>

            <ul class="list-group mt-2" *ngIf="resultadosBusquedaSocio.length > 0 && !socioSeleccionado">
              <li class="list-group-item list-group-item-action cursor-pointer" 
                  *ngFor="let s of resultadosBusquedaSocio" (click)="seleccionarSocio(s)">
                <strong>{{ s.nombre }} {{ s.apellido }}</strong> - {{ s.dni }}
              </li>
            </ul>
            
            <div *ngIf="socioSeleccionado" class="alert alert-success mt-2 py-2">
              <i class="bi bi-person-check-fill me-2"></i> {{ socioSeleccionado.nombre }} {{ socioSeleccionado.apellido }}
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Tipo de Pago (*)</label>
              <select class="form-select" [(ngModel)]="currentPago.tipoPago" name="tipoPago" required (change)="onTipoPagoChange()"> 
                <option *ngFor="let tipo of tiposDePago" [value]="tipo">{{ tipo }}</option>
              </select>
            </div>

            <div class="col-md-6 mb-3" *ngIf="currentPago.tipoPago === 'MULTA'">
              <label class="form-label text-danger">Seleccionar Multa (*)</label>
              <select class="form-select border-danger" [(ngModel)]="currentPago.idMulta" name="idMulta" required (change)="onMultaSelect()">
                <option [ngValue]="undefined" disabled>-- Seleccione --</option>
                <option *ngFor="let m of multasPendientes" [value]="m.id">#{{ m.id }} - {{ m.motivo }} (S/ {{ m.monto }})</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Monto (S/)</label>
              <input type="number" class="form-control" [(ngModel)]="currentPago.monto" name="monto" required min="0.1" step="0.01">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Fecha (*)</label>
              <input type="datetime-local" class="form-control" [(ngModel)]="currentPago.fechaPago" name="fechaPago" required>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Observación</label>
            <textarea class="form-control" [(ngModel)]="currentPago.observacion" name="observacion" rows="2"></textarea>
          </div>
        
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="closePagoModal()">Cancelar</button>
            <button type="submit" class="btn btn-primary" 
                    [disabled]="pagoForm.invalid || !socioSeleccionado || (currentPago.tipoPago === 'MULTA' && !currentPago.idMulta)">
              Guardar Pago
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- MODAL BORRAR -->
<div class="modal fade" #deleteConfirmModal id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirmar Eliminación</h5>
        <button type="button" class="btn-close" (click)="closeDeleteModal()"></button>
      </div>
      <div class="modal-body"><p>¿Eliminar pago?</p></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeDeleteModal()">Cancelar</button>
        <button type="button" class="btn btn-danger" (click)="confirmDelete()">Eliminar</button>
      </div>
    </div>
  </div>
</div>