<div class="container-fluid">
  
  <!-- ALERTA DE ÉXITO -->
  <div *ngIf="successMessage" class="alert alert-success alert-dismissible fade show" role="alert">
    <i class="bi bi-check-circle-fill me-2"></i> {{ successMessage }}
    <button type="button" class="btn-close" (click)="successMessage = null"></button>
  </div>

  <div class="card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h2 class="h4 mb-0">Gestión de Multas</h2>
      <button class="btn btn-primary" (click)="openModal()">
        <i class="bi bi-plus-lg me-2"></i> Generar Multa
      </button>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
          <thead class="table-dark">
            <tr>
              <th>ID</th>
              <th>Socio</th>
              <th>Motivo</th>
              <th>Monto</th>
              <th>Estado</th>
              <th>Fecha Emisión</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let multa of multas">
              <td>{{ multa.id }}</td>
              <td>{{ multa.socioNombreCompleto }}</td>
              <td>{{ multa.motivo }}</td>
              <td>S/ {{ multa.monto | number:'1.2-2' }}</td>
              <td>
                <span class="badge" 
                  [class.bg-warning]="multa.estado === 'PENDIENTE'" 
                  [class.bg-success]="multa.estado === 'PAGADO'">
                  {{ multa.estado }}
                </span>
              </td>
              <td>{{ multa.fechaEmision }}</td>
              <td>
                <button class="btn btn-sm btn-warning me-2" (click)="openModal(multa)">
                  <i class="bi bi-pencil-fill"></i>
                </button>
                <button class="btn btn-sm btn-danger" (click)="openDeleteModal(multa)">
                  <i class="bi bi-trash-fill"></i>
                </button>
              </td>
            </tr>
            <tr *ngIf="multas.length === 0">
              <td colspan="7" class="text-center text-muted">No hay multas registradas</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal Generar/Editar -->
<div class="modal fade" #multaModal id="multaModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{{ modalTitle }}</h5>
        <button type="button" class="btn-close" (click)="closeMultaModal()"></button>
      </div>
      <div class="modal-body">
        
        <div *ngIf="errorMessage" class="alert alert-danger">{{ errorMessage }}</div>

        <form #multaForm="ngForm" (ngSubmit)="saveMulta()">
          
          <div class="mb-3">
            <label class="form-label">Socio (*)</label>
            <select class="form-select" [(ngModel)]="currentMulta.idSocio" name="idSocio" required
                    #socioCtrl="ngModel" [class.is-invalid]="socioCtrl.invalid && (socioCtrl.dirty || socioCtrl.touched)">
              <option [value]="0" disabled>-- Seleccione --</option>
              <option *ngFor="let s of socios" [value]="s.id">
                {{ s.nombre }} {{ s.apellido }} ({{ s.dni }})
              </option>
            </select>
            <div class="invalid-feedback">Debe seleccionar un socio.</div>
          </div>

          <div class="mb-3">
            <label class="form-label">Motivo (*)</label>
            <select class="form-select" [(ngModel)]="currentMulta.motivo" name="motivo" required
                    #motivoCtrl="ngModel" [class.is-invalid]="motivoCtrl.invalid && (motivoCtrl.dirty || motivoCtrl.touched)">
              <option *ngFor="let m of motivos" [value]="m">{{ m }}</option>
            </select>
            <div class="invalid-feedback">El motivo es obligatorio.</div>
          </div>

          <div class="mb-3">
            <label class="form-label">Monto (S/) (*)</label>
            <input type="number" class="form-control" [(ngModel)]="currentMulta.monto" name="monto" 
                   required min="0.1" step="0.01" #montoCtrl="ngModel"
                   [class.is-invalid]="montoCtrl.invalid && (montoCtrl.dirty || montoCtrl.touched)">
            <div class="invalid-feedback">El monto es obligatorio y debe ser mayor a 0.</div>
          </div>

          <!-- Solo mostrar estado al editar, al crear es PENDIENTE por defecto -->
          <div class="mb-3" *ngIf="currentMultaId">
            <label class="form-label">Estado</label>
            <select class="form-select" [(ngModel)]="currentMulta.estado" name="estado">
              <option value="PENDIENTE">PENDIENTE</option>
              <option value="PAGADA">PAGADA</option>
            </select>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="closeMultaModal()">Cancelar</button>
            <!-- Deshabilitar si form inválido O si no hay cambios en edición -->
            <button type="submit" class="btn btn-primary" 
                    [disabled]="multaForm.invalid || (currentMultaId && !hasChanges())">
              Guardar
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Modal Borrar -->
<div class="modal fade" #deleteConfirmModal id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirmar Eliminación</h5>
        <button type="button" class="btn-close" (click)="closeDeleteModal()"></button>
      </div>
      <div class="modal-body">
        <p>¿Eliminar multa #{{ multaAEliminar?.id }}?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeDeleteModal()">Cancelar</button>
        <button type="button" class="btn btn-danger" (click)="confirmDelete()">Eliminar</button>
      </div>
    </div>
  </div>
</div>